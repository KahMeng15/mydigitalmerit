<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merit Values Migration Tool - Digital Merit System</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container flex justify-between items-center">
            <a href="dashboard.html" class="navbar-brand">Merit System Admin</a>
            <ul class="navbar-nav">
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="merit-values.html" class="nav-link">Merit Values</a></li>
                <li><span id="userDisplayName" class="nav-link"></span></li>
                <li><button id="signOutBtn" class="btn btn-outline btn-sm">Sign Out</button></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Header -->
            <div class="mb-6">
                <h1 class="text-2xl font-bold mb-2">Merit Values Migration Tool</h1>
                <p class="text-secondary">Migrate from legacy merit values structure to the new event-based and competition-based merit system</p>
            </div>

            <!-- Migration Status -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">Migration Status</h3>
                </div>
                <div class="card-body">
                    <div id="migrationStatusDisplay" class="mb-4">
                        <div class="text-center py-4">
                            <button id="checkStatusBtn" class="btn btn-primary">Check Migration Status</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Migration Steps -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Step 1: Create Event Merit Values -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Step 1: Create Event Merit Values</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-secondary mb-4">Initialize the new eventMeritValues collection with predefined committee and non-committee roles for event activities.</p>
                        
                        <div class="mb-4">
                            <h5 class="font-medium mb-2">Committee Member Roles:</h5>
                            <ul class="text-sm text-secondary space-y-1">
                                <li>‚Ä¢ Pengarah, Timb. Pengarah</li>
                                <li>‚Ä¢ Setiausaha, Timb. Setiausaha</li>
                                <li>‚Ä¢ Bendahari, Timb. Bendahari</li>
                                <li>‚Ä¢ AJK (Multimedia, Program, Protocol, etc.)</li>
                            </ul>
                        </div>

                        <div class="mb-4">
                            <h5 class="font-medium mb-2">Non-Committee Roles:</h5>
                            <ul class="text-sm text-secondary space-y-1">
                                <li>‚Ä¢ Peserta (Participant)</li>
                                <li>‚Ä¢ Penyokong (Supporter)</li>
                                <li>‚Ä¢ Sukarelawanan (Volunteer)</li>
                            </ul>
                        </div>
                        
                        <button id="createEventMeritsBtn" class="btn btn-primary w-full">Create Event Merit Values</button>
                        <div id="eventMeritsStatus" class="mt-2 text-sm"></div>
                    </div>
                </div>

                <!-- Step 2: Create Competition Merit Values -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Step 2: Create Competition Merit Values</h3>
                    </div>
                    <div class="card-body">
                        <p class="text-secondary mb-4">Initialize the new competitionMeritValues collection with competition-specific achievements and rankings.</p>
                        
                        <div class="mb-4">
                            <h5 class="font-medium mb-2">Competition Achievements:</h5>
                            <ul class="text-sm text-secondary space-y-1">
                                <li>‚Ä¢ Johan (Champion)</li>
                                <li>‚Ä¢ Naib Johan (Runner-up)</li>
                                <li>‚Ä¢ Ketiga (Third Place)</li>
                            </ul>
                        </div>

                        <div class="mb-4">
                            <h5 class="font-medium mb-2">Competition Levels:</h5>
                            <ul class="text-sm text-secondary space-y-1">
                                <li>‚Ä¢ Tempat, Johan, Naib Johan</li>
                                <li>‚Ä¢ Ketiga, Penyertaan, Penyokong</li>
                            </ul>
                        </div>
                        
                        <button id="createCompetitionMeritsBtn" class="btn btn-success w-full">Create Competition Merit Values</button>
                        <div id="competitionMeritsStatus" class="mt-2 text-sm"></div>
                    </div>
                </div>
            </div>

            <!-- Data Preview -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">Data Preview</h3>
                </div>
                <div class="card-body">
                    <div class="flex gap-2 mb-4">
                        <button id="previewEventBtn" class="btn btn-outline">Preview Event Merits</button>
                        <button id="previewCompetitionBtn" class="btn btn-outline">Preview Competition Merits</button>
                        <button id="previewLegacyBtn" class="btn btn-outline">Preview Legacy Data</button>
                    </div>
                    <div id="dataPreview" class="bg-gray-50 p-4 rounded border min-h-32">
                        <div class="text-center text-secondary">Select a preview option above to view data structure</div>
                    </div>
                </div>
            </div>

            <!-- Legacy Data Management -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Legacy Data Management</h3>
                </div>
                <div class="card-body">
                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg mb-4">
                        <h5 class="font-medium text-yellow-800 mb-2">‚ö†Ô∏è Important Notice</h5>
                        <p class="text-sm text-yellow-700">The old meritvalue collection will remain available for reference. Only proceed with cleanup after confirming the new system works correctly.</p>
                    </div>
                    
                    <div class="flex gap-2">
                        <button id="backupLegacyBtn" class="btn btn-warning">Backup Legacy Data</button>
                        <button id="exportLegacyBtn" class="btn btn-outline">Export Legacy JSON</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="d-none">
        <div class="spinner"></div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Application Scripts -->
    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script>
        // Migration Tool functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Check admin authentication
            if (!requireAdmin()) return;

            // Initialize page
            initializePage();
            setupEventListeners();
        });

        function initializePage() {
            // Display user info
            const user = getCurrentUser();
            if (user) {
                document.getElementById('userDisplayName').textContent = user.displayName || user.email;
            }
        }

        function setupEventListeners() {
            // Sign out
            document.getElementById('signOutBtn').addEventListener('click', signOut);
            
            // Status check
            document.getElementById('checkStatusBtn').addEventListener('click', checkMigrationStatus);
            
            // Migration actions
            document.getElementById('createEventMeritsBtn').addEventListener('click', createEventMerits);
            document.getElementById('createCompetitionMeritsBtn').addEventListener('click', createCompetitionMerits);
            
            // Preview actions
            document.getElementById('previewEventBtn').addEventListener('click', () => previewData('event'));
            document.getElementById('previewCompetitionBtn').addEventListener('click', () => previewData('competition'));
            document.getElementById('previewLegacyBtn').addEventListener('click', () => previewData('legacy'));
            
            // Legacy data management
            document.getElementById('backupLegacyBtn').addEventListener('click', backupLegacyData);
            document.getElementById('exportLegacyBtn').addEventListener('click', exportLegacyData);
        }

        async function checkMigrationStatus() {
            try {
                showLoading();

                const statusDiv = document.getElementById('migrationStatusDisplay');
                let statusHtml = '<div class="grid grid-cols-1 md:grid-cols-3 gap-4">';

                // Check eventMeritValues collection
                const eventSnapshot = await firestore.collection('eventMeritValues').get();
                const eventDocsCount = eventSnapshot.size;
                statusHtml += `
                    <div class="p-4 border rounded-lg ${eventDocsCount > 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full ${eventDocsCount > 0 ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span class="font-medium">Event Merit Values</span>
                        </div>
                        <p class="text-sm text-secondary">${eventDocsCount} documents found</p>
                    </div>`;

                // Check competitionMeritValues collection
                const compSnapshot = await firestore.collection('competitionMeritValues').get();
                const compDocsCount = compSnapshot.size;
                statusHtml += `
                    <div class="p-4 border rounded-lg ${compDocsCount > 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full ${compDocsCount > 0 ? 'bg-green-500' : 'bg-red-500'}"></span>
                            <span class="font-medium">Competition Merit Values</span>
                        </div>
                        <p class="text-sm text-secondary">${compDocsCount} documents found</p>
                    </div>`;

                // Check old meritvalue collection
                const oldSnapshot = await firestore.collection('meritvalue').get();
                const oldDocsCount = oldSnapshot.size;
                statusHtml += `
                    <div class="p-4 border rounded-lg ${oldDocsCount > 0 ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-200'}">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="w-3 h-3 rounded-full ${oldDocsCount > 0 ? 'bg-yellow-500' : 'bg-gray-400'}"></span>
                            <span class="font-medium">Legacy Merit Values</span>
                        </div>
                        <p class="text-sm text-secondary">${oldDocsCount} documents found</p>
                    </div>`;

                statusHtml += '</div>';

                // Add migration recommendations
                if (eventDocsCount === 0 || compDocsCount === 0) {
                    statusHtml += `
                        <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h5 class="font-medium text-blue-800 mb-2">üìã Next Steps</h5>
                            <ul class="text-sm text-blue-700 space-y-1">
                                ${eventDocsCount === 0 ? '<li>‚Ä¢ Run Step 1 to create Event Merit Values</li>' : ''}
                                ${compDocsCount === 0 ? '<li>‚Ä¢ Run Step 2 to create Competition Merit Values</li>' : ''}
                            </ul>
                        </div>`;
                } else {
                    statusHtml += `
                        <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                            <h5 class="font-medium text-green-800 mb-2">‚úÖ Migration Complete</h5>
                            <p class="text-sm text-green-700">New merit values structure has been successfully created. You can now use the updated Merit Values configuration page.</p>
                        </div>`;
                }

                statusDiv.innerHTML = statusHtml;

            } catch (error) {
                console.error('Error checking migration status:', error);
                document.getElementById('migrationStatusDisplay').innerHTML = 
                    '<div class="text-center py-4"><div class="text-red-600">Error checking migration status</div></div>';
            } finally {
                hideLoading();
            }
        }

        async function createEventMerits() {
            try {
                showLoading();
                const statusDiv = document.getElementById('eventMeritsStatus');
                statusDiv.innerHTML = '<span class="text-blue-600">Creating event merit values...</span>';

                const defaultCommitteeRoles = {
                    pengarah: {
                        nameBM: 'Pengarah',
                        nameEN: 'Director',
                        blok: 5, fakulti: 10, persatuan: 10, universiti: 12, intervarsiti: 14, negeri: 16, kebangsaan: 18, antarabangsa: 20
                    },
                    timbPengarah: {
                        nameBM: 'Timb. Pengarah',
                        nameEN: 'Deputy Director',
                        blok: 4, fakulti: 8, persatuan: 8, universiti: 10, intervarsiti: 12, negeri: 14, kebangsaan: 16, antarabangsa: 19
                    },
                    setiausaha: {
                        nameBM: 'Setiausaha',
                        nameEN: 'Secretary',
                        blok: 4, fakulti: 8, persatuan: 6, universiti: 8, intervarsiti: 10, negeri: 12, kebangsaan: 14, antarabangsa: 18
                    },
                    timbSetiausaha: {
                        nameBM: 'Timb. Setiausaha',
                        nameEN: 'Deputy Secretary',
                        blok: 3, fakulti: 6, persatuan: 6, universiti: 8, intervarsiti: 10, negeri: 12, kebangsaan: 14, antarabangsa: 17
                    },
                    bendahari: {
                        nameBM: 'Bendahari',
                        nameEN: 'Treasurer',
                        blok: 4, fakulti: 8, persatuan: 6, universiti: 8, intervarsiti: 10, negeri: 12, kebangsaan: 14, antarabangsa: 17
                    },
                    timbBendahari: {
                        nameBM: 'Timb. Bendahari',
                        nameEN: 'Deputy Treasurer',
                        blok: 3, fakulti: 6, persatuan: 6, universiti: 8, intervarsiti: 10, negeri: 12, kebangsaan: 14, antarabangsa: 16
                    },
                    ajkMultimedia: {
                        nameBM: 'AJK Multimedia',
                        nameEN: 'Multimedia Committee',
                        blok: 2, fakulti: 4, persatuan: 2, universiti: 4, intervarsiti: 5, negeri: 6, kebangsaan: 7, antarabangsa: 8
                    },
                    ajkPendaftaran: {
                        nameBM: 'AJK Pendaftaran',
                        nameEN: 'Registration Committee',
                        blok: 2, fakulti: 4, persatuan: 2, universiti: 4, intervarsiti: 5, negeri: 6, kebangsaan: 7, antarabangsa: 8
                    },
                    ajkProgram: {
                        nameBM: 'AJK Program',
                        nameEN: 'Programme Committee',
                        blok: 2, fakulti: 4, persatuan: 2, universiti: 4, intervarsiti: 5, negeri: 6, kebangsaan: 7, antarabangsa: 8
                    },
                    ajkProtokol: {
                        nameBM: 'AJK Protokol',
                        nameEN: 'Protocol Committee',
                        blok: 2, fakulti: 4, persatuan: 2, universiti: 4, intervarsiti: 5, negeri: 6, kebangsaan: 7, antarabangsa: 8
                    },
                    ajkPeralatan: {
                        nameBM: 'AJK Peralatan',
                        nameEN: 'Equipment Committee',
                        blok: 2, fakulti: 4, persatuan: 2, universiti: 4, intervarsiti: 5, negeri: 6, kebangsaan: 7, antarabangsa: 8
                    },
                    ajkMakanan: {
                        nameBM: 'AJK Makanan',
                        nameEN: 'Food Committee',
                        blok: 2, fakulti: 4, persatuan: 2, universiti: 4, intervarsiti: 5, negeri: 6, kebangsaan: 7, antarabangsa: 8
                    },
                    ajkKebersihan: {
                        nameBM: 'AJK Kebersihan',
                        nameEN: 'Cleanliness Committee',
                        blok: 2, fakulti: 4, persatuan: 2, universiti: 4, intervarsiti: 5, negeri: 6, kebangsaan: 7, antarabangsa: 8
                    },
                    ajkKeselamatan: {
                        nameBM: 'AJK Keselamatan',
                        nameEN: 'Security Committee',
                        blok: 2, fakulti: 4, persatuan: 2, universiti: 4, intervarsiti: 5, negeri: 6, kebangsaan: 7, antarabangsa: 8
                    },
                    ajkDekorasi: {
                        nameBM: 'AJK Dekorasi',
                        nameEN: 'Decoration Committee',
                        blok: 2, fakulti: 4, persatuan: 2, universiti: 4, intervarsiti: 5, negeri: 6, kebangsaan: 7, antarabangsa: 8
                    },
                    ajkTugasKhas: {
                        nameBM: 'AJK Tugas Khas',
                        nameEN: 'Special Task Committee',
                        blok: 2, fakulti: 4, persatuan: 2, universiti: 4, intervarsiti: 5, negeri: 6, kebangsaan: 7, antarabangsa: 8
                    },
                    ajkPersembahan: {
                        nameBM: 'AJK Persembahan',
                        nameEN: 'Performance Committee',
                        blok: 2, fakulti: 4, persatuan: 2, universiti: 4, intervarsiti: 5, negeri: 6, kebangsaan: 7, antarabangsa: 8
                    }
                };

                const defaultNonCommitteeRoles = {
                    peserta: {
                        nameBM: 'Peserta',
                        nameEN: 'Participant',
                        blok: 1, fakulti: 2, persatuan: 1, universiti: 2, intervarsiti: 3, negeri: 4, kebangsaan: 5, antarabangsa: 6
                    },
                    penyokong: {
                        nameBM: 'Penyokong',
                        nameEN: 'Supporter',
                        blok: 1, fakulti: 1, persatuan: 1, universiti: 1, intervarsiti: 1, negeri: 2, kebangsaan: 1, antarabangsa: 1
                    },
                    sukarelawan: {
                        nameBM: 'Sukarelawanan',
                        nameEN: 'Volunteer',
                        blok: 1, fakulti: 2, persatuan: 2, universiti: 2, intervarsiti: 3, negeri: 4, kebangsaan: 5, antarabangsa: 6
                    }
                };

                // Save to Firestore
                await firestore.collection('eventMeritValues').doc('committee').set(defaultCommitteeRoles);
                await firestore.collection('eventMeritValues').doc('nonCommittee').set(defaultNonCommitteeRoles);

                statusDiv.innerHTML = '<span class="text-green-600">‚úÖ Event merit values created successfully!</span>';
                showToast('Event merit values created successfully', 'success');
                
                // Refresh status
                setTimeout(() => checkMigrationStatus(), 1000);

            } catch (error) {
                console.error('Error creating event merits:', error);
                document.getElementById('eventMeritsStatus').innerHTML = '<span class="text-red-600">‚ùå Error creating event merits</span>';
                showToast('Error creating event merits: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function createCompetitionMerits() {
            try {
                showLoading();
                const statusDiv = document.getElementById('competitionMeritsStatus');
                statusDiv.innerHTML = '<span class="text-blue-600">Creating competition merit values...</span>';

                const defaultCompetitionAchievements = {
                    johan: {
                        nameBM: 'Johan',
                        nameEN: 'Champion',
                        tempat: 20, johan: 19, naibJohan: 18, ketiga: 17, penyertaan: 1, penyokong: 1
                    },
                    naibJohan: {
                        nameBM: 'Naib Johan', 
                        nameEN: 'Runner-up',
                        tempat: 18, johan: 16, naibJohan: 14, ketiga: 7, penyertaan: 1, penyokong: 1
                    },
                    ketiga: {
                        nameBM: 'Ketiga',
                        nameEN: 'Third Place',
                        tempat: 16, johan: 14, naibJohan: 12, ketiga: 6, penyertaan: 1, penyokong: 1
                    }
                };

                // Save each achievement as separate document
                const batch = firestore.batch();
                Object.entries(defaultCompetitionAchievements).forEach(([key, data]) => {
                    const docRef = firestore.collection('competitionMeritValues').doc(key);
                    batch.set(docRef, data);
                });
                
                await batch.commit();

                statusDiv.innerHTML = '<span class="text-green-600">‚úÖ Competition merit values created successfully!</span>';
                showToast('Competition merit values created successfully', 'success');
                
                // Refresh status
                setTimeout(() => checkMigrationStatus(), 1000);

            } catch (error) {
                console.error('Error creating competition merits:', error);
                document.getElementById('competitionMeritsStatus').innerHTML = '<span class="text-red-600">‚ùå Error creating competition merits</span>';
                showToast('Error creating competition merits: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function previewData(type) {
            try {
                showLoading();
                const previewDiv = document.getElementById('dataPreview');
                let data = {};

                switch(type) {
                    case 'event':
                        const eventSnapshot = await firestore.collection('eventMeritValues').get();
                        eventSnapshot.forEach(doc => {
                            data[doc.id] = doc.data();
                        });
                        break;
                    case 'competition':
                        const compSnapshot = await firestore.collection('competitionMeritValues').get();
                        compSnapshot.forEach(doc => {
                            data[doc.id] = doc.data();
                        });
                        break;
                    case 'legacy':
                        const legacySnapshot = await firestore.collection('meritvalue').get();
                        legacySnapshot.forEach(doc => {
                            data[doc.id] = doc.data();
                        });
                        break;
                }

                previewDiv.innerHTML = `<pre class="text-xs overflow-auto">${JSON.stringify(data, null, 2)}</pre>`;

            } catch (error) {
                console.error('Error previewing data:', error);
                document.getElementById('dataPreview').innerHTML = '<div class="text-red-600">Error loading preview</div>';
            } finally {
                hideLoading();
            }
        }

        function backupLegacyData() {
            showToast('Backup functionality will create a timestamped backup in Firebase', 'info');
        }

        async function exportLegacyData() {
            try {
                showLoading();
                
                const snapshot = await firestore.collection('meritvalue').get();
                const data = {};
                snapshot.forEach(doc => {
                    data[doc.id] = doc.data();
                });

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `legacy-merit-values-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                showToast('Legacy data exported successfully', 'success');

            } catch (error) {
                console.error('Error exporting legacy data:', error);
                showToast('Error exporting legacy data: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>