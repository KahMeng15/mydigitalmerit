<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Add Admin</title>
  <link rel="stylesheet" href="/assets/css/main.css">
  <style>
    .container { max-width:720px; margin:3rem auto; }
    .card { padding:1.25rem; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06); background:#fff }
    .muted { color:#666; font-size:0.9rem }
    table { width:100%; border-collapse:collapse; margin-top:1rem }
    th,td { text-align:left; padding:8px; border-bottom:1px solid #eee }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>Add Admin</h2>
      <p class="muted">This page writes a single admin entry to the Realtime Database under <code>admins/{'{email-sanitized}'}</code>.</p>

      <label for="adminEmail">Admin email</label>
      <input id="adminEmail" type="email" value="kmeng.development@gmail.com" style="width:100%; padding:8px; margin-top:6px;" />
      <div style="margin-top:12px; display:flex; gap:8px;">
        <button id="addBtn" class="btn btn-primary">Add Admin</button>
        <button id="removeBtn" class="btn btn-danger">Remove Admin</button>
      </div>

      <div id="status" style="margin-top:12px"></div>

      <table id="resultTable" class="d-none" aria-live="polite">
        <thead>
          <tr id="tableHeadRow"></tr>
        </thead>
        <tbody id="tableBodyRow">
        </tbody>
      </table>

    </div>
  </div>

  <!-- Firebase v9 compat SDKs (matching index.html) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // Prevent firebase-config.js from redirecting unauthenticated users on this standalone admin tool page
    window.SKIP_AUTH_REDIRECT = true;
  </script>
  <script src="/assets/js/firebase-config.js"></script>
  <!-- App utilities (includes sanitizeEmailForKey / unsanitizeKey) -->
  <script src="/assets/js/utils.js"></script>

  <script>
  // Use app-wide helpers from utils.js: sanitizeEmailForKey, unsanitizeKey

    const addBtn = document.getElementById('addBtn');
    const removeBtn = document.getElementById('removeBtn');
    const statusEl = document.getElementById('status');
    const table = document.getElementById('resultTable');
    const tableHeadRow = document.getElementById('tableHeadRow');
    const tableBodyRow = document.getElementById('tableBodyRow');
    const adminEmailInput = document.getElementById('adminEmail');

    function showStatus(msg, type='info') {
      statusEl.textContent = msg;
      statusEl.className = type === 'error' ? 'bad' : 'ok';
    }

    function renderTableForEmail(emailKey, value) {
      table.classList.remove('d-none');
      tableHeadRow.innerHTML = '';
      tableBodyRow.innerHTML = '';

      // Use the email (unsanitized) as the table header, per request
      const th = document.createElement('th');
      th.textContent = unsanitizeKey(emailKey);
      tableHeadRow.appendChild(th);

      const td = document.createElement('td');
      td.textContent = JSON.stringify(value);
      tableBodyRow.appendChild(td);
    }

    addBtn.addEventListener('click', async function() {
      const email = adminEmailInput.value.trim();
      if (!email) return showStatus('Enter an email', 'error');

      const key = sanitizeEmailForKey(email);
      try {
        // Write to Firestore: admins/{sanitizedEmail} = {active:true}
  await firestore.collection('admins').doc(key).set({active: true});
        showStatus('Admin added: ' + email);
        renderTableForEmail(key, true);
      } catch (err) {
        console.error(err);
        showStatus('Error adding admin: ' + err.message, 'error');
      }
    });

    removeBtn.addEventListener('click', async function() {
      const email = adminEmailInput.value.trim();
      if (!email) return showStatus('Enter an email', 'error');

      const key = sanitizeEmailForKey(email);
      try {
  await firestore.collection('admins').doc(key).delete();
        showStatus('Admin removed: ' + email);
        renderTableForEmail(key, null);
      } catch (err) {
        console.error(err);
        showStatus('Error removing admin: ' + err.message, 'error');
      }
    });
  </script>
</body>
</html>
