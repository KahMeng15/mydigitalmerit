<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merit Values ID Migration - Digital Merit System</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container flex justify-between items-center">
            <a href="dashboard.html" class="navbar-brand">Merit System Admin</a>
            <ul class="navbar-nav">
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="merit-values.html" class="nav-link">Merit Values</a></li>
                <li><span id="userDisplayName" class="nav-link"></span></li>
                <li><button id="signOutBtn" class="btn btn-outline btn-sm">Sign Out</button></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Header -->
            <div class="mb-6">
                <h1 class="text-2xl font-bold mb-2">Merit Values ID Migration</h1>
                <p class="text-secondary">Migrate merit values from name-based keys to unique ID-based structure</p>
            </div>

            <!-- Migration Status -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">Migration Status</h3>
                </div>
                <div class="card-body">
                    <div id="migrationStatusDisplay" class="mb-4">
                        <div class="text-center py-4">
                            <button id="checkStatusBtn" class="btn btn-primary">Check Migration Status</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Migration Information -->
            <div class="card mb-6">
                <div class="card-header">
                    <h3 class="card-title">What This Migration Does</h3>
                </div>
                <div class="card-body">
                    <div class="space-y-4">
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <h4 class="font-medium text-blue-800 mb-2">üîÑ Migration Process</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚Ä¢ Converts all merit roles and achievements to use unique IDs instead of names</li>
                                <li>‚Ä¢ Preserves all existing merit values and names</li>
                                <li>‚Ä¢ Creates automatic backups before making changes</li>
                                <li>‚Ä¢ Updates database structure for better reliability</li>
                            </ul>
                        </div>

                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <h4 class="font-medium text-green-800 mb-2">‚úÖ Benefits</h4>
                            <ul class="text-sm text-green-700 space-y-1">
                                <li>‚Ä¢ Eliminates name conflicts between roles</li>
                                <li>‚Ä¢ Allows safe renaming of roles without breaking data</li>
                                <li>‚Ä¢ Improves data integrity and consistency</li>
                                <li>‚Ä¢ Future-proofs the system for complex scenarios</li>
                            </ul>
                        </div>

                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <h4 class="font-medium text-yellow-800 mb-2">‚ö†Ô∏è Important Notes</h4>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                <li>‚Ä¢ Migration creates automatic backups with timestamps</li>
                                <li>‚Ä¢ Process is irreversible once completed</li>
                                <li>‚Ä¢ All existing merit values will be preserved</li>
                                <li>‚Ä¢ Users may need to refresh their browsers after migration</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Migration Actions -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Migration Actions</h3>
                </div>
                <div class="card-body">
                    <div class="flex gap-4">
                        <button id="runMigrationBtn" class="btn btn-success" disabled>
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            Run Migration
                        </button>
                        <button id="createDefaultsBtn" class="btn btn-outline">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Create Default Values
                        </button>
                        <a href="merit-values.html" class="btn btn-primary">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back to Merit Values
                        </a>
                    </div>

                    <div id="migrationProgress" class="mt-4 d-none">
                        <div class="text-center py-4">
                            <div class="spinner"></div>
                            <p class="mt-2 text-secondary">Migration in progress...</p>
                        </div>
                    </div>

                    <div id="migrationResult" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Firebase Configuration -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/merit-values-new.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check admin authentication
            if (!requireAdmin()) return;

            // Initialize page
            initializePage();
            setupEventListeners();
        });

        function initializePage() {
            // Display user info
            const user = getCurrentUser();
            if (user) {
                document.getElementById('userDisplayName').textContent = user.displayName || user.email;
            }
        }

        function setupEventListeners() {
            // Sign out
            document.getElementById('signOutBtn').addEventListener('click', signOut);
            
            // Migration actions
            document.getElementById('checkStatusBtn').addEventListener('click', checkMigrationStatus);
            document.getElementById('runMigrationBtn').addEventListener('click', runMigration);
            document.getElementById('createDefaultsBtn').addEventListener('click', createDefaults);
        }

        async function checkMigrationStatus() {
            try {
                showLoading();
                
                const status = await checkIfMigrationNeeded();
                const statusDiv = document.getElementById('migrationStatusDisplay');
                
                if (status.error) {
                    statusDiv.innerHTML = `
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <h4 class="font-medium text-red-800">Error Checking Status</h4>
                            <p class="text-sm text-red-600 mt-1">${status.error}</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div class="space-y-3">';
                
                if (status.needed) {
                    html += `
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <h4 class="font-medium text-yellow-800 mb-2">‚ö†Ô∏è Migration Required</h4>
                            <div class="text-sm text-yellow-700 space-y-1">
                                <p><strong>Event Merit Values:</strong> ${status.events ? 'Needs migration' : 'Already migrated'}</p>
                                <p><strong>Competition Merit Values:</strong> ${status.competitions ? 'Needs migration' : 'Already migrated'}</p>
                                <p><strong>Event Documents:</strong> ${status.eventDocs}</p>
                                <p><strong>Competition Documents:</strong> ${status.competitionDocs}</p>
                            </div>
                        </div>
                    `;
                    document.getElementById('runMigrationBtn').disabled = false;
                } else {
                    html += `
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <h4 class="font-medium text-green-800 mb-2">‚úÖ Migration Complete</h4>
                            <div class="text-sm text-green-700 space-y-1">
                                <p>All merit values are already using the ID-based structure.</p>
                                <p><strong>Event Documents:</strong> ${status.eventDocs}</p>
                                <p><strong>Competition Documents:</strong> ${status.competitionDocs}</p>
                            </div>
                        </div>
                    `;
                    document.getElementById('runMigrationBtn').disabled = true;
                }

                html += '</div>';
                statusDiv.innerHTML = html;

            } catch (error) {
                console.error('Error checking migration status:', error);
                showToast('Error checking status: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function runMigration() {
            const confirm = window.confirm(
                'Are you sure you want to run the migration?\n\n' +
                'This will:\n' +
                '‚Ä¢ Create backups of all existing data\n' +
                '‚Ä¢ Convert merit values to use unique IDs\n' +
                '‚Ä¢ Update the database structure\n\n' +
                'This process cannot be reversed!'
            );

            if (!confirm) return;

            try {
                document.getElementById('migrationProgress').classList.remove('d-none');
                document.getElementById('runMigrationBtn').disabled = true;
                
                await migrateToIdBasedStructure();
                
                document.getElementById('migrationResult').innerHTML = `
                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                        <h4 class="font-medium text-green-800">‚úÖ Migration Completed Successfully!</h4>
                        <p class="text-sm text-green-600 mt-1">All merit values have been converted to the ID-based structure.</p>
                    </div>
                `;

                // Refresh status
                setTimeout(checkMigrationStatus, 1000);

            } catch (error) {
                console.error('Migration error:', error);
                document.getElementById('migrationResult').innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                        <h4 class="font-medium text-red-800">‚ùå Migration Failed</h4>
                        <p class="text-sm text-red-600 mt-1">${error.message}</p>
                    </div>
                `;
            } finally {
                document.getElementById('migrationProgress').classList.add('d-none');
                document.getElementById('runMigrationBtn').disabled = false;
            }
        }

        async function createDefaults() {
            try {
                showLoading();
                
                await createDefaultEventMerits();
                await createDefaultCompetitionMerits();
                
                showToast('Default merit values created successfully', 'success');
                
                // Refresh status
                setTimeout(checkMigrationStatus, 1000);

            } catch (error) {
                console.error('Error creating defaults:', error);
                showToast('Error creating defaults: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>